name: Generate Release Notes

on:
  schedule:
    - cron: '0 8 * * 1' # Runs every Monday at 08:00 UTC
  workflow_dispatch:
    inputs:
      source_repos:
        description: "Comma-separated repos to check"
        required: false
        default: "hotwax/fulfillment,hotwax/inventory-count,hotwax/transfers,hotwax/bopis,hotwax/receiving,hotwax/facilities"
      month:
        description: "Month to generate notes for (YYYY-MM format, e.g., 2026-01). Defaults to previous month if not specified."
        required: false

jobs:
  run-agent:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_GITHUB }}
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config --global user.email "release-bot@users.noreply.github.com"
          git config --global user.name "Release Notes Bot"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node dependencies
        run: npm ci

      - name: Run release notes generator
        env:
          SOURCE_REPOS: ${{ inputs.source_repos || 'hotwax/fulfillment,hotwax/inventory-count,hotwax/transfers,hotwax/bopis,hotwax/receiving,hotwax/facilities' }}
          MONTH: ${{ inputs.month }}
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TARGET_REPO: shubham-namdeo/UDM-Assignment
        run: node scripts/generate-release-notes.js

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_GITHUB }}
          commit-message: "docs: add release notes drafts"
          branch: release-notes-update
          delete-branch: true
          title: "Release Notes Drafts"
          body: |
            Automated release notes drafts generated by Gemini.
            
            Please review the files in `drafts/` and publish them when ready.
          add-paths: |
            drafts/
